db_schema:
  bounded_context: "ProductCatalog"
  description: "Database schema cho Product Category management"
  
  ddl_statements: |
    -- Bảng tenants (root table)
    CREATE TABLE IF NOT EXISTS `tenants` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `name` varchar(50) NOT NULL,
      `status` int(11) NOT NULL DEFAULT 1,
      `remaining_account_quota` int(11) NOT NULL DEFAULT 0 COMMENT 'số lượng tài khoản có thể tạo thêm trong công ty',
      `total_account_quota` int(11) NOT NULL DEFAULT 0 COMMENT 'số lượng tài khoản tối đa trong công ty, -1 là không giới hạn',
      `created_at` datetime DEFAULT current_timestamp(),
      `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
      PRIMARY KEY (`id`),
      KEY `name` (`name`)
    );

    -- Bảng users (cho workspace)
    CREATE TABLE IF NOT EXISTS `users` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `user_name` varchar(50) NOT NULL,
      `password` varchar(200) NOT NULL,
      `phone_number` varchar(50) DEFAULT NULL,
      `created_at` datetime DEFAULT current_timestamp(),
      `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
      `lock_counter` tinyint(4) DEFAULT NULL COMMENT 'Số lần đăng nhập sai liên tiếp',
      `auto_lock_time` int(11) DEFAULT NULL COMMENT 'Thời gian khóa sau khi đăng nhập sai liên tiếp quá nhiều',
      PRIMARY KEY (`id`),
      UNIQUE KEY `user_name` (`user_name`)
    );

    -- Bảng workspaces (liên kết user-tenant)
    CREATE TABLE IF NOT EXISTS `workspaces` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `status` int(11) NOT NULL DEFAULT 1 COMMENT '0: tạm ngừng, 1: hoạt động',
      `user_id` bigint(20) unsigned NOT NULL,
      `tenant_id` bigint(20) unsigned NOT NULL,
      `created_at` datetime DEFAULT current_timestamp(),
      `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
      PRIMARY KEY (`id`),
      KEY `FK_users_TO_workspaces` (`user_id`),
      KEY `FK_tenants_TO_workspaces` (`tenant_id`),
      CONSTRAINT `FK_tenants_TO_workspaces` FOREIGN KEY (`tenant_id`) REFERENCES `tenants` (`id`),
      CONSTRAINT `FK_users_TO_workspaces` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
    );

    -- Bảng branches (chi nhánh)
    CREATE TABLE IF NOT EXISTS `branches` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `name` varchar(100) NOT NULL,
      `tenant_id` bigint(20) unsigned NOT NULL DEFAULT 0,
      `created_at` datetime DEFAULT current_timestamp(),
      `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
      `primary_phone` varchar(20) NOT NULL,
      `secondary_phone` varchar(20) DEFAULT NULL,
      `note` varchar(250) DEFAULT NULL,
      `address` varchar(200) DEFAULT NULL,
      `code` varchar(100) DEFAULT NULL,
      `status` int(11) NOT NULL DEFAULT 1 COMMENT '0: tạm ngừng, 1: hoạt động',
      `creator_id` bigint(20) unsigned DEFAULT NULL,
      PRIMARY KEY (`id`),
      KEY `FK_tenants_TO_branches` (`tenant_id`),
      KEY `idx_branches_created_at` (`created_at`),
      KEY `FK_branch_employees_TO_creators` (`creator_id`),
      FULLTEXT KEY `idx_branches_name_ft` (`name`),
      CONSTRAINT `FK_branch_employees_TO_creators` FOREIGN KEY (`creator_id`) REFERENCES `employees` (`id`),
      CONSTRAINT `FK_tenants_TO_branches` FOREIGN KEY (`tenant_id`) REFERENCES `tenants` (`id`)
    );

    -- Bảng resellers (nhà phân phối)
    CREATE TABLE IF NOT EXISTS `resellers` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `name` varchar(150) NOT NULL,
      `tenant_id` bigint(20) unsigned NOT NULL,
      `code` varchar(100) DEFAULT NULL,
      `address` varchar(250) DEFAULT NULL,
      `created_at` datetime DEFAULT current_timestamp(),
      `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
      `phone` varchar(20) DEFAULT NULL,
      `status` int(11) NOT NULL DEFAULT 1 COMMENT '0: tạm ngừng, 1: hoạt động',
      `note` text DEFAULT NULL,
      `creator_id` bigint(20) unsigned DEFAULT NULL,
      PRIMARY KEY (`id`),
      KEY `FK_tenants_TO_resellers` (`tenant_id`),
      KEY `idx_resellers_created_at` (`created_at`),
      FULLTEXT KEY `idx_resellers_name_ft` (`name`),
      FULLTEXT KEY `idx_resellers_code_ft` (`code`),
      CONSTRAINT `FK_tenants_TO_resellers` FOREIGN KEY (`tenant_id`) REFERENCES `tenants` (`id`)
    );

    -- Bảng employees (nhân viên - có circular dependency với branches)
    CREATE TABLE IF NOT EXISTS `employees` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `name` varchar(150) NOT NULL,
      `workspace_id` bigint(20) unsigned NOT NULL,
      `reseller_id` bigint(20) unsigned DEFAULT NULL,
      `branch_id` bigint(20) unsigned DEFAULT NULL,
      `status` int(11) NOT NULL DEFAULT 1 COMMENT '0: tạm ngừng, 1: hoạt động',
      `dob` date DEFAULT NULL COMMENT 'ngày sinh',
      `email` varchar(200) DEFAULT NULL COMMENT 'email',
      `gender` int(11) DEFAULT 1 COMMENT '0: khác, 1: nam, 2: nữ',
      `address` varchar(250) DEFAULT NULL,
      `note` varchar(250) DEFAULT NULL,
      `created_at` datetime DEFAULT current_timestamp(),
      `creator_id` bigint(20) unsigned DEFAULT NULL COMMENT 'người tạo',
      `type` int(11) NOT NULL DEFAULT 1 COMMENT '0: tài khoản ẩn, 1: tài khoản bình thường',
      `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
      PRIMARY KEY (`id`),
      KEY `FK_workspaces_TO_employees` (`workspace_id`),
      KEY `FK_resellers_TO_employees` (`reseller_id`),
      KEY `FK_branches_TO_employees` (`branch_id`),
      KEY `FK_employees_TO_employees` (`creator_id`),
      KEY `idx_employees_created_at` (`created_at`),
      FULLTEXT KEY `idx_employees_name_ft` (`name`),
      CONSTRAINT `FK_branches_TO_employees` FOREIGN KEY (`branch_id`) REFERENCES `branches` (`id`),
      CONSTRAINT `FK_employees_TO_employees` FOREIGN KEY (`creator_id`) REFERENCES `employees` (`id`),
      CONSTRAINT `FK_resellers_TO_employees` FOREIGN KEY (`reseller_id`) REFERENCES `resellers` (`id`),
      CONSTRAINT `FK_workspaces_TO_employees` FOREIGN KEY (`workspace_id`) REFERENCES `workspaces` (`id`)
    );

    -- Bảng product_categories (danh mục sản phẩm - cây phân cấp)
    CREATE TABLE IF NOT EXISTS `product_categories` (
      `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
      `name` varchar(100) NOT NULL,
      `tenant_id` bigint(20) unsigned NOT NULL,
      `product_category_parent_id` bigint(20) unsigned DEFAULT NULL,
      `level` int(11) NOT NULL DEFAULT 1,
      `created_at` datetime DEFAULT current_timestamp(),
      `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
      `parent_level1_id` bigint(11) unsigned DEFAULT NULL,
      `parent_level2_id` bigint(11) unsigned DEFAULT NULL,
      `active_status` bigint(11) unsigned DEFAULT NULL,
      `creator_id` bigint(20) unsigned DEFAULT NULL,
      PRIMARY KEY (`id`),
      KEY `FK_tenants_TO_product_categories` (`tenant_id`),
      KEY `FK_product_categories_TO_product_categories` (`product_category_parent_id`),
      KEY `FK_employees_TO_product_categories` (`creator_id`),
      KEY `fk_parent_level1` (`parent_level1_id`),
      KEY `fk_parent_level2` (`parent_level2_id`),
      KEY `idx_product_categories_created_at` (`created_at`),
      FULLTEXT KEY `idx_product_categories_name_ft` (`name`),
      CONSTRAINT `FK_product_categories_TO_product_categories` FOREIGN KEY (`product_category_parent_id`) REFERENCES `product_categories` (`id`),
      CONSTRAINT `FK_empployees_TO_product_categories` FOREIGN KEY (`creator_id`) REFERENCES `employees` (`id`),
      CONSTRAINT `FK_tenants_TO_product_categories` FOREIGN KEY (`tenant_id`) REFERENCES `tenants` (`id`),
      CONSTRAINT `fk_parent_level1` FOREIGN KEY (`parent_level1_id`) REFERENCES `product_categories` (`id`) ON DELETE SET NULL,
      CONSTRAINT `fk_parent_level2` FOREIGN KEY (`parent_level2_id`) REFERENCES `product_categories` (`id`) ON DELETE SET NULL
    );

test_plan:
  test_suite: GetListProductCategory
  testcase: |
    # BASE CASE
    - id: AC_OFAT_00
      title: "[BASE]<Case cơ sở hợp lệ>"
      key_factors: [productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        productCategoryName: "Điện thoại 123"
        activeStatuses: [1]
        productCategoryAncestors: [1]
        tenantId: 11
        page: 1
        size: 20
      expected: "Validation Passed. DTO được tạo thành công với các giá trị đã được chuẩn hoá (nếu có)."
      layer: presentation
      type: UTRequest
      test_class: GetListProductCategoryRequest

    # OFAT TESTS - productCategoryName
    - id: AC_OFAT_01
      title: "[productCategoryName]Sai kiểu dữ liệu"
      key_factors: [productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        productCategoryName: 123
        activeStatuses: [1]
        productCategoryAncestors: [1]
        tenantId: 11
        page: 1
        size: 20
      expected:
        status: 422
        code: VALIDATION_ERROR
        title: "Validation Failed"
        detail: "Dữ liệu đầu vào không hợp lệ."
        errors: [{field: productCategoryName, code: invalid_type, message: "Trường productCategoryName sai kiểu dữ liệu."}]
      layer: presentation
      type: UTRequest
      test_class: GetListProductCategoryRequest
    - id: AC_Pairwise_17
      title: "Pairwise: activeStatuses × productCategoryAncestors"
      key_factors: [productCategoryName, activeStatuses, tenantId, page, size]
      input:
        productCategoryName: "Điện thoại 123"
        activeStatuses: [0, 1]
        tenantId: 11
        page: 1
        size: 20
      expected: "(Integration Rule) Handler gọi repo thật. (Data Mapping Rule): Output DTO có cấu trúc: {total: ..., page: 1, size: 20, productCategories: [{productCategoryId: <id>, productCategoryName: '...', productCategoryParentId: <id_or_null>, productCategoryGrandParentId: <id_or_null>, productCategoryGrandParentName: '<name_or_null>', creatorName: '...', createdAt: '<timestamp>', activeStatus: <0_or_1>}, ...]}"
      layer: application
      type: ITQueryHandler
      test_class: GetListProductCategoryQueryHandler

    - id: AC_Pairwise_18
      title: "Pairwise: activeStatuses × productCategoryAncestors"
      key_factors: [productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        productCategoryName: "Điện thoại 123"
        activeStatuses: [0, 1]
        productCategoryAncestors: []
        tenantId: 11
        page: 1
        size: 20
      expected:
        total: <count_theo_seed_data>
        page: 1
        size: 20
        items: [{productCategoryId: <id>, productCategoryName: <name>, productCategoryParentId: <id_or_null>, productCategoryGrandParentId: <id_or_null>, productCategoryGrandParentName: <name_or_null>, creatorName: <name>, createdAt: <timestamp>, activeStatus: <0_or_1>}]
      layer: infrastructure
      type: ITQueryRepository
      test_class: GetListProductCategoryQueryRepository

    - id: AC_Pairwise_19
      title: "Pairwise: activeStatuses × productCategoryAncestors"
      key_factors: [productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        productCategoryName: "Điện thoại 123"
        activeStatuses: [0, 1]
        productCategoryAncestors: [1]
        tenantId: 11
        page: 1
        size: 20
      expected:
        total: <count_theo_seed_data>
        page: 1
        size: 20
        items: [{productCategoryId: <id>, productCategoryName: <name>, productCategoryParentId: <id_or_null>, productCategoryGrandParentId: <id_or_null>, productCategoryGrandParentName: <name_or_null>, creatorName: <name>, createdAt: <timestamp>, activeStatus: <0_or_1>}]
      layer: infrastructure
      type: ITQueryRepository
      test_class: GetListProductCategoryQueryRepository

    - id: AC_Pairwise_20
      title: "Pairwise: activeStatuses × productCategoryAncestors (chọn case 'không dữ liệu' ở expected)"
      key_factors: [productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        productCategoryName: "Điện thoại 123"
        activeStatuses: [0, 1]
        productCategoryAncestors: [1, 2]
        tenantId: 11
        page: 1
        size: 20
      expected:
        total: 0
        page: 1
        size: 20
        items: []
      layer: infrastructure
      type: ITQueryRepository
      test_class: GetListProductCategoryQueryRepository

    # E2E TESTS
    - id: AC_E2E_01
      title: "[E2E-Happy path (có data)]Truy vấn danh mục theo tên + trạng thái + ancestor"
      key_factors: [auth, productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        auth:
          access_token: "{{token_valid}}"
        productCategoryName: "Điện thoại 123"
        activeStatuses: [1, 0]
        productCategoryAncestors: [1]
        tenantId: 11
        page: 1
        size: 20
      expected:
        total: <count_gt_0>
        page: 1
        size: 20
        items: [{productCategoryId: <id>, productCategoryName: <name>, productCategoryParentId: <id_or_null>, productCategoryGrandParentId: <id_or_null>, productCategoryGrandParentName: <name_or_null>, creatorName: <name>, createdAt: <timestamp>, activeStatus: <0_or_1>}]
      layer: presentation
      type: E2E
      test_class: GetListProductCategoryE2E

    - id: AC_E2E_02
      title: "[E2E-Happy path (không data)]Tìm với điều kiện hợp lệ nhưng không khớp"
      key_factors: [auth, productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        auth:
          access_token: "{{token_valid}}"
        productCategoryName: "Tên danh mục không tồn tại XYZ"
        activeStatuses: []
        productCategoryAncestors: []
        tenantId: 11
        page: 1
        size: 20
      expected:
        total: 0
        page: 1
        size: 20
        items: []
      layer: presentation
      type: E2E
      test_class: GetListProductCategoryE2E

    - id: AC_E2E_03
      title: "[E2E-Validation 422]Input sai định dạng"
      key_factors: [auth, productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        auth:
          access_token: "{{token_valid}}"
        productCategoryName: ""
        activeStatuses: [1]
        productCategoryAncestors: [1]
        tenantId: 11
        page: 1
        size: 20
      expected:
        type: "about:blank"
        status: 422
        code: "VALIDATION_ERROR"
        title: "Validation Failed"
        detail: "Dữ liệu đầu vào không hợp lệ."
        instance: "<request_path>"
        traceId: "<traceId>"
        errors: [{field: "productCategoryName", code: "empty_or_blank", message: "Trường productCategoryName không được rỗng hoặc chỉ chứa khoảng trắng."}]
      layer: presentation
      type: E2E
      test_class: GetListProductCategoryE2E

    - id: AC_E2E_04
      title: "[E2E-Unauthorized 401]Không đăng nhập/Token không hợp lệ"
      key_factors: [auth, productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        auth:
          access_token: null
        productCategoryName: "Điện thoại 123"
        activeStatuses: [1]
        productCategoryAncestors: [1]
        tenantId: 11
        page: 1
        size: 20
      expected:
        type: "about:blank"
        status: 401
        code: "AUTH_INVALID_TOKEN"
        title: "Authentication Required"
        detail: "Token xác thực không hợp lệ hoặc đã hết hạn."
        instance: "<request_path>"
        traceId: "<traceId>"
        errors: []
      layer: presentation
      type: E2E
      test_class: GetListProductCategoryE2E

    - id: AC_E2E_05
      title: "[E2E-Forbidden 403]Đăng nhập không đủ quyền/sai scope"
      key_factors: [auth, productCategoryName, activeStatuses, productCategoryAncestors, tenantId, page, size]
      input:
        auth:
          access_token: "{{token_no_scope}}"
        productCategoryName: "Điện thoại 123"
        activeStatuses: [1]
        productCategoryAncestors: [1]
        tenantId: 11
        page: 1
        size: 20
      expected:
        type: "about:blank"
        status: 403
        code: "PERMISSION_DENIED"
        title: "Access Denied"
        detail: "Bạn không có quyền thực hiện hành động này."
        instance: "<request_path>"
        traceId: "<traceId>"
        errors: []
      layer: presentation
      type: E2E
      test_class: GetListProductCategoryE2E